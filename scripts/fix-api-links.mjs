import { glob } from 'glob';
import { readFileSync, writeFileSync } from 'fs';
import { execSync } from 'child_process';

/**
 * Post-process TypeDoc-generated markdown files to:
 * 1. Add/update Docusaurus frontmatter with custom_edit_url: null to disable "Edit this page"
 * 2. Remove .md extensions from links (Docusaurus compatibility)
 * 3. Fix MDX compatibility issues (escape HTML-like tags, fix code blocks)
 */

const apiDir = 'docs/docs/developing/api';

async function fixMarkdownLinks() {
  // Find all markdown files in the API directory
  const files = await glob(`${apiDir}/**/*.md`);
  
  console.log(`Processing ${files.length} markdown files...`);
  
  let totalReplacements = 0;
  
  for (const file of files) {
    let content = readFileSync(file, 'utf-8');
    const originalContent = content;
    
    // 0. Add or update Docusaurus frontmatter (required for Docusaurus to recognize files)
    // Disable "Edit this page" for autogenerated API docs by setting custom_edit_url: null
    if (!content.startsWith('---')) {
      // Extract a title from the first heading or filename
      const titleMatch = content.match(/^#+\s+(.+)$/m);
      const relativePath = file.replace(apiDir + '/', '').replace('.md', '');
      // Docusaurus id should be just the filename (no slashes), path is derived from file location
      const docId = relativePath;
      const title = titleMatch ? titleMatch[1].trim() : relativePath;
      
      // Add frontmatter with id matching just the filename (no path)
      // Quote title to handle special characters like parentheses
      const quotedTitle = title.includes(':') || title.includes('(') || title.includes(')') || title.includes("'")
        ? `"${title.replace(/"/g, '\\"')}"`
        : title;
      // Include custom_edit_url: null to disable "Edit this page" for autogenerated docs
      content = `---\nid: ${docId}\ntitle: ${quotedTitle}\ncustom_edit_url: null\n---\n\n${content}`;
    } else {
      // File already has frontmatter - ensure custom_edit_url: null is present
      // Parse frontmatter using regex to find the closing ---
      // Match frontmatter that ends with --- followed by optional newline
      const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---(\n|$)/);
      if (frontmatterMatch) {
        const frontmatterContent = frontmatterMatch[1];
        const body = content.substring(frontmatterMatch[0].length);
        
        // Check if custom_edit_url is already present
        if (!frontmatterContent.includes('custom_edit_url:')) {
          // Add custom_edit_url: null to the frontmatter
          const updatedFrontmatter = `---\n${frontmatterContent}\ncustom_edit_url: null\n---\n`;
          content = updatedFrontmatter + body;
        } else if (!frontmatterContent.match(/custom_edit_url:\s*null/)) {
          // Update existing custom_edit_url to null if it has a different value
          const updatedFrontmatterContent = frontmatterContent.replace(/custom_edit_url:\s*[^\n]+/g, 'custom_edit_url: null');
          content = `---\n${updatedFrontmatterContent}\n---\n${body}`;
        }
      }
    }
    
    // 1. Replace .md extensions in markdown links: [text](path/to/file.md) -> [text](path/to/file)
    content = content.replace(/\]\(([^)]+)\.md\)/g, ']($1)');
    
    // 2. Fix links with .md and anchors: [text](path/to/file.md#anchor) -> [text](path/to/file#anchor)
    content = content.replace(/\]\(([^)]+)\.md(#.*?)\)/g, ']($1$2)');
    
    // 3. Escape HTML-like tags that MDX interprets incorrectly
    // Fix <verb phrase> -> verb phrase (remove angle brackets)
    content = content.replace(/<verb phrase>/g, 'verb phrase');
    content = content.replace(/<verb>/g, 'verb');
    
    // 4. Fix relative "index" and "api-overview" links - all files are in same directory
    // Skip this for the api-overview.md file itself  
    if (!file.endsWith('api-overview.md')) {
      // Since all files are flattened into the same directory, use just "api-overview"
      content = content.replace(/\]\(index\)/g, '](api-overview)');
      content = content.replace(/\]\(\.\/index\)/g, '](api-overview)');
      content = content.replace(/\]\(developing\/api\/index\)/g, '](api-overview)');
      content = content.replace(/\]\(\.\.\/api-reference\)/g, '](api-overview)');
    }
    
    // 5. Fix module links in api-overview.md - use relative paths since all files are in same dir
    if (file.endsWith('api-overview.md')) {
      // All files are in the same directory, so links should be relative
      // Keep links as-is since they're already relative (components.auth.LoginForm)
    }
    
    // 6. Fix function/variable links - use relative paths for flattened files
    // Links like ](components.auth.LoginForm.Function.LoginForm) are already relative
    // No change needed since all files are in the same directory
    
    // 7. Fix code examples with arrows - ensure they're properly formatted
    // Fix examples that have arrows outside code blocks
    // Look for "Examples:" followed by lines with arrows that aren't in code blocks
    if (content.includes('Examples:') && content.includes('→')) {
      // Check if examples are already in a code block
      const examplesMatch = content.match(/Examples:([\s\S]*?)(?=\n##|\n#|$)/);
      if (examplesMatch && !examplesMatch[1].includes('```')) {
        // Wrap examples in a code block
        const examples = examplesMatch[1].trim();
        content = content.replace(
          /Examples:[\s\S]*?(?=\n##|\n#|$)/,
          `Examples:\n\n\`\`\`ts\n${examples}\n\`\`\``
        );
      }
    }
    
    if (content !== originalContent) {
      writeFileSync(file, content, 'utf-8');
      const replacements = (originalContent.match(/\.md\)|<verb|→/g) || []).length;
      totalReplacements += replacements;
    }
  }
  
  console.log(`Fixed ${totalReplacements} issues across ${files.length} files.`);
  
  // Generate API sidebar configuration
  console.log('Generating API sidebar configuration...');
  try {
    execSync('node scripts/generate-api-sidebar.mjs', { stdio: 'inherit' });
  } catch (error) {
    console.error('Failed to generate API sidebar:', error.message);
    process.exit(1);
  }
}

fixMarkdownLinks().catch(console.error);

