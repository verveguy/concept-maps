import { glob } from 'glob';
import { readFileSync, writeFileSync } from 'fs';

/**
 * Generate sidebar configuration for API documentation from TypeDoc-generated files.
 * This script scans the generated API markdown files and creates a sidebar structure.
 */

const apiDir = 'docs/docs/developing/api';
const outputFile = 'docs/sidebars.api.ts';

/**
 * Extract a readable label from a filename
 */
function getLabel(filename) {
  // Remove .md extension
  const name = filename.replace('.md', '');
  
  // Skip detail files (Function, Variable, Interface, TypeAlias)
  if (name.includes('.Function.') || name.includes('.Variable.') || 
      name.includes('.Interface.') || name.includes('.TypeAlias.')) {
    return null;
  }
  
  // Extract the last part after the last dot
  const parts = name.split('.');
  const lastPart = parts[parts.length - 1];
  
  // For hooks, preserve camelCase (e.g., useConceptActions)
  if (name.startsWith('hooks.')) {
    return lastPart;
  }
  
  // For stores, preserve camelCase (e.g., mapStore)
  if (name.startsWith('stores.')) {
    return lastPart;
  }
  
  // For lib utilities, preserve camelCase (e.g., textRepresentation)
  if (name.startsWith('lib.')) {
    return lastPart;
  }
  
  // For components, convert camelCase to Title Case
  const label = lastPart
    .replace(/([A-Z])/g, ' $1')
    .replace(/^./, str => str.toUpperCase())
    .trim();
  
  return label;
}

/**
 * Categorize files by their prefix
 */
function categorizeFile(filename) {
  if (filename.startsWith('components.')) {
    return 'components';
  } else if (filename.startsWith('hooks.')) {
    return 'hooks';
  } else if (filename.startsWith('lib.')) {
    return 'lib';
  } else if (filename.startsWith('stores.')) {
    return 'stores';
  }
  return null;
}

async function generateApiSidebar() {
  // Find all markdown files in the API directory
  const files = await glob(`${apiDir}/*.md`);
  
  // Filter out detail files and api-overview
  const mainFiles = files
    .map(file => file.replace(apiDir + '/', ''))
    .filter(file => {
      const name = file.replace('.md', '');
      return name !== 'api-overview' && 
             !name.includes('.Function.') && 
             !name.includes('.Variable.') && 
             !name.includes('.Interface.') && 
             !name.includes('.TypeAlias.');
    });
  
  // Group files by category
  const categories = {
    components: [],
    hooks: [],
    lib: [],
    stores: [],
  };
  
  for (const file of mainFiles) {
    const category = categorizeFile(file);
    if (category) {
      const label = getLabel(file);
      if (label) {
        const docId = file.replace('.md', '');
        categories[category].push({
          id: `developing/api/${docId}`,
          label,
        });
      }
    }
  }
  
  // Sort each category alphabetically by label
  Object.keys(categories).forEach(key => {
    categories[key].sort((a, b) => a.label.localeCompare(b.label));
  });
  
  // Generate TypeScript code
  const generateCategory = (items, label) => {
    if (items.length === 0) return '';
    
    const itemsCode = items
      .map(item => `        { type: 'doc', id: '${item.id}', label: '${item.label}' }`)
      .join(',\n');
    
    return `      {\n        type: 'category',\n        label: '${label}',\n        collapsed: true,\n        items: [\n${itemsCode},\n        ],\n      }`;
  };
  
  const componentsSection = generateCategory(categories.components, 'Components');
  const hooksSection = generateCategory(categories.hooks, 'Hooks');
  const libSection = generateCategory(categories.lib, 'Utilities');
  const storesSection = generateCategory(categories.stores, 'Stores');
  
  const sections = [
    componentsSection,
    hooksSection,
    libSection,
    storesSection,
  ].filter(Boolean);
  
  const code = `/**
 * Auto-generated API sidebar configuration.
 * This file is generated by scripts/generate-api-sidebar.mjs
 * DO NOT EDIT MANUALLY - changes will be overwritten.
 */

import type { SidebarsConfig } from '@docusaurus/plugin-content-docs';

/**
 * API Reference sidebar items (auto-generated from TypeDoc output)
 */
export const apiSidebarItems = [
  'developing/api-reference',
  'developing/api/api-overview'${sections.length > 0 ? ',\n' + sections.join(',\n') : ''}
];
`;

  writeFileSync(outputFile, code, 'utf-8');
  console.log(`Generated API sidebar config: ${outputFile}`);
  console.log(`  - Components: ${categories.components.length} items`);
  console.log(`  - Hooks: ${categories.hooks.length} items`);
  console.log(`  - Utilities: ${categories.lib.length} items`);
  console.log(`  - Stores: ${categories.stores.length} items`);
}

generateApiSidebar().catch(console.error);

